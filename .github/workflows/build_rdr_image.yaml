name: Build Containers

on:
  pull_request:
    types:
      - labeled

env:
  REGISTRY_USER: ${{ secrets.QUAY_USER }}
  IMAGE_REGISTRY: quay.io/ocsci
  REGISTRY_PASSWORD: ${{ secrets.QUAY_SECRET }}

jobs:
  build_containers:
    name: Build and Push Container
    runs-on: ubuntu-latest

    # Run only for specific labels
    if: |
      github.event.label.name == 'force_build_image' ||
      github.event.label.name == 'build_image'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4.1.7
        with:
          fetch-depth: 0

      # Detect Dockerfile changes
      - name: Detect Dockerfile changes
        id: check_dockerfile
        run: |
          echo "üîç Checking for Dockerfile changes..."
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q 'Dockerfile'; then
            echo "dockerfile_changed=true" >> $GITHUB_ENV
            echo "‚úÖ Dockerfile changes detected."
          else
            echo "dockerfile_changed=false" >> $GITHUB_ENV
            echo "üõë No Dockerfile changes detected."
          fi

      # Skip build if not forced and no Dockerfile change
      - name: Skip build if not forced and no Dockerfile change
        if: |
          github.event.label.name == 'build_image' && env.dockerfile_changed != 'true'
        run: |
          echo "‚è≠Ô∏è Skipping build: 'build_image' label added but no Dockerfile changes found."
          echo "skip_build=true" >> $GITHUB_ENV

      # Comment on PR when skipped
      - name: Comment on PR (Skipped)
        if: env.skip_build == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚ö†Ô∏è **Build Skipped**
            No Dockerfile changes were detected in this PR.
            Label: `${{ github.event.label.name }}`

      # Stop early if skipped
      - name: Stop Job
        if: env.skip_build == 'true'
        run: exit 0

      # Set up QEMU
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.2.0

      # üè∑Ô∏è Set Tags (PR + Target Branch)
      - name: Set image tags
        id: set_tags
        run: |
          PR_TAG="pr-${{ github.event.pull_request.number }}"
          BASE_TAG="$(echo "${{ github.base_ref }}" | tr '/' '-')"
          echo "tags=${PR_TAG} ${BASE_TAG}" >> $GITHUB_OUTPUT
          echo "üßæ Using tags: ${PR_TAG} ${BASE_TAG}"

      # Build Image
      - name: Buildah Build
        id: build-image
        uses: redhat-actions/buildah-build@v2
        with:
          image: rdr-ocs-workload
          tags: ${{ steps.set_tags.outputs.tags }}
          # platforms: linux/amd64,linux/arm64
          platforms: linux/386,linux/amd64,linux/arm/v6,linux/arm/v7,linux/arm64/v8,linux/ppc64le,linux/riscv64,linux/s390x
          containerfiles: |
            ./rdr/container_image/Dockerfile

      # Push Image to Quay.io
      - name: Push to Quay.io
        id: push-to-quay
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          username: ${{ env.REGISTRY_USER }}
          password: ${{ env.REGISTRY_PASSWORD }}
          registry: ${{ env.IMAGE_REGISTRY }}

      # Comment on PR for Build Success
      - name: Comment on PR (Build Success)
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ‚úÖ **Image Build Complete**
            The container image was built and pushed successfully for branch `${{ github.head_ref }}`  
            Label: `${{ github.event.label.name }}`
            üè∑Ô∏è Image tags: `${{ steps.set_tags.outputs.tags }}`

      # # üßπ Remove trigger label so it can be reused
      # - name: Remove trigger label
      #   uses: actions-ecosystem/action-remove-labels@v1
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     labels: ${{ github.event.label.name }}
